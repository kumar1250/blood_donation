{% extends "base.html" %}
{% block title %}Update Location{% endblock %}

{% block content %}
<h2>Updating your location...</h2>
<p>Please allow location access in your browser. This may take a few seconds.</p>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Get request_id from template context safely
const requestId = {{ request_id|default:"null" }};

if (!requestId) {
    alert("Request ID not found. Cannot update location.");
} else if (navigator.geolocation) {
    function sendLocation() {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                // Replace "0" in URL with actual requestId
                fetch("{% url 'blood_requests:update_requester_location' request_id=0 %}".replace("0", requestId), {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    })
                }).then(() => {
                    window.location.href = "{% url 'blood_requests:request_list' %}";
                }).catch(err => {
                    console.error("Error updating location:", err);
                });
            },
            function(error) {
                alert("Please allow location access! Error: " + error.message);
            },
            { enableHighAccuracy: true }
        );
    }

    // Initial send
    sendLocation();
    // Optional: continuous updates every 5 seconds
    setInterval(sendLocation, 5000);
} else {
    alert("Geolocation not supported in your browser.");
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Share Location{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-primary mb-4">Share Your Location</h2>

<<<<<<< HEAD
    <div class="mb-3">
        <label for="search" class="form-label">Search by Village/Location (India only)</label>
        <input type="text" class="form-control" id="search" placeholder="Enter village name">
        <button type="button" class="btn btn-outline-secondary mt-2" onclick="searchLocation()">🔍 Search</button>
    </div>

    <form method="post" id="locationForm">
        {% csrf_token %}
        <div class="mb-3">
            <label for="lat" class="form-label">Latitude</label>
            <input type="text" class="form-control" id="lat" name="lat" readonly required>
        </div>
        <div class="mb-3">
            <label for="lng" class="form-label">Longitude</label>
            <input type="text" class="form-control" id="lng" name="lng" readonly required>
        </div>
        <button type="button" class="btn btn-outline-primary" onclick="getLocation()">📍 Use My Current Location</button>
        <button type="submit" class="btn btn-success">Save Location</button>
    </form>

=======
    <!-- Search by village/location -->
    <div class="mb-3">
        <label for="search" class="form-label">Search by Village/Location (India only)</label>
        <div class="input-group">
            <input type="text" class="form-control" id="search" placeholder="Enter village name">
            <button class="btn btn-outline-secondary" type="button" onclick="searchLocation()">🔍 Search</button>
        </div>
    </div>

    <!-- Location form -->
    <form method="post" id="locationForm">
        {% csrf_token %}
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="lat" class="form-label">Latitude</label>
                <input type="text" class="form-control" id="lat" name="lat" readonly required>
            </div>
            <div class="col-md-6">
                <label for="lng" class="form-label">Longitude</label>
                <input type="text" class="form-control" id="lng" name="lng" readonly required>
            </div>
        </div>

        <div class="mb-3">
            <button type="button" class="btn btn-outline-primary me-2" onclick="getLocation()">📍 Use My Current Location</button>
            <button type="submit" class="btn btn-success">💾 Save Location</button>
        </div>
    </form>

    <!-- Map -->
>>>>>>> 6942391 (Initial commit: Updated project with new files and blood camp changes blood camp)
    <div id="map" style="height: 500px; border-radius: 10px; margin-top: 15px;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
<<<<<<< HEAD
let map;
let marker;

// Initialize map at default coordinates (India center)
function initMap(lat=20.5937, lng=78.9629) {
    map = L.map('map').setView([lat, lng], 5); // Zoomed out for full India
=======
let map, marker;

// Initialize map at given coordinates
function initMap(lat, lng) {
    map = L.map('map').setView([lat, lng], 15); // Zoomed closer
>>>>>>> 6942391 (Initial commit: Updated project with new files and blood camp changes blood camp)

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

<<<<<<< HEAD
    marker = L.marker([lat, lng], {draggable:true}).addTo(map)
        .bindPopup("Drag to adjust location")
        .openPopup();

    marker.on("dragend", function(e){
        const pos = e.target.getLatLng();
        document.getElementById("lat").value = pos.lat;
        document.getElementById("lng").value = pos.lng;
    });

    document.getElementById("lat").value = lat;
    document.getElementById("lng").value = lng;
}

// Get current GPS location
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setView([lat, lng], 15);
            marker.setLatLng([lat, lng]);
            document.getElementById("lat").value = lat;
            document.getElementById("lng").value = lng;
        }, error => {
            alert("Could not get your location: " + error.message);
        }, {enableHighAccuracy:true});
    } else {
        alert("Geolocation not supported.");
    }
}

// Search village/location restricted to India
function searchLocation() {
    const query = document.getElementById("search").value;
    if (!query) { alert("Enter a village or location name"); return; }

    // Nominatim API search restricted to India using countrycodes=IN
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=IN&limit=5`)
    .then(response => response.json())
    .then(data => {
        if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lng = parseFloat(data[0].lon);
            map.setView([lat, lng], 15);
            marker.setLatLng([lat, lng]);
            document.getElementById("lat").value = lat;
            document.getElementById("lng").value = lng;
        } else {
            alert("Location not found in India.");
        }
    })
    .catch(err => console.error(err));
}

// Initialize map on page load
initMap();
=======
    marker = L.marker([lat, lng], { draggable:true }).addTo(map)
        .bindPopup("Drag to adjust location")
        .openPopup();

    // Update form fields on marker drag
    marker.on("dragend", function(e){
        const pos = e.target.getLatLng();
        document.getElementById("lat").value = pos.lat.toFixed(6);
        document.getElementById("lng").value = pos.lng.toFixed(6);
    });

    // Set initial form values
    document.getElementById("lat").value = lat.toFixed(6);
    document.getElementById("lng").value = lng.toFixed(6);
}

// Get user's current location and initialize map
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            if (!map) {
                initMap(lat, lng); // initialize first time
            } else {
                map.setView([lat, lng], 15);
                marker.setLatLng([lat, lng]);
            }
            document.getElementById("lat").value = lat.toFixed(6);
            document.getElementById("lng").value = lng.toFixed(6);
        }, err => {
            alert("Could not get your location: " + err.message);
            // Fallback to India center
            if (!map) initMap(20.5937, 78.9629);
        }, { enableHighAccuracy: true });
    } else {
        alert("Geolocation not supported by your browser.");
        if (!map) initMap(20.5937, 78.9629);
    }
}

// Search location restricted to India using Nominatim
function searchLocation() {
    const query = document.getElementById("search").value.trim();
    if (!query) { alert("Enter a village or location name."); return; }

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=IN&limit=5`)
        .then(res => res.json())
        .then(data => {
            if (data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lng = parseFloat(data[0].lon);
                map.setView([lat, lng], 15);
                marker.setLatLng([lat, lng]);
                document.getElementById("lat").value = lat.toFixed(6);
                document.getElementById("lng").value = lng.toFixed(6);
            } else {
                alert("Location not found in India.");
            }
        })
        .catch(err => console.error(err));
}

// Auto-detect location on page load
getLocation();
>>>>>>> 6942391 (Initial commit: Updated project with new files and blood camp changes blood camp)
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Donor Map{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-danger mb-4">Donor Map for {{ br.name }}</h2>
    <div id="map" style="height: 500px; border-radius: 10px;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const requesterLat = {{ br.requester_lat|default:"null" }};
const requesterLng = {{ br.requester_lng|default:"null" }};
const mapLat = (requesterLat !== null) ? requesterLat : 17.0;
const mapLng = (requesterLng !== null) ? requesterLng : 82.0;

const map = L.map('map').setView([mapLat, mapLng], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

if (requesterLat !== null && requesterLng !== null) {
    L.marker([requesterLat, requesterLng]).addTo(map).bindPopup("Requester: {{ br.name }}").openPopup();
}

const donors = [
    {% for d in br.donor_locations.all %}
    {username: "{{ d.donor.username }}", lat: {{ d.lat }}, lng: {{ d.lng }}},
    {% endfor %}
];

const points = [];
if (requesterLat !== null && requesterLng !== null) {
    points.push([requesterLat, requesterLng]);
}
donors.forEach(d => {
    if (d.lat && d.lng) {
        L.marker([d.lat, d.lng]).addTo(map).bindPopup("Donor: " + d.username);
        points.push([d.lat, d.lng]);
    }
});
if (points.length > 1) {
    L.polyline(points, {color: 'red', weight: 3, opacity: 0.7}).addTo(map);
}
</script>
{% endblock %}

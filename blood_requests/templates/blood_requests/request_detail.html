{% extends "base.html" %}
{% block title %}Request Details{% endblock %}

{% block content %}
<h2>Request Details</h2>

<div>
    <h3>{{ br.name }} ({{ br.blood_group }})</h3>
    <p><strong>Address:</strong> {{ br.address }}</p>
    <p><strong>Reason:</strong> {{ br.reason|default:"N/A" }}</p>
    <p><strong>Requested By:</strong> {{ br.requester.username }}</p>
</div>

<!-- Map -->
<div id="map" style="height: 400px;"></div>

<script>
    let map = L.map('map').setView([16.3067, 80.4365], 13); // default view
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
    }).addTo(map);

    let requesterMarker = null;
    let donorMarkers = {};

    function fetchLocations() {
        fetch("{% url 'live_tracking:donors_for_request' br.id %}")
            .then(res => res.json())
            .then(data => {
                // Update requester marker
                if (data.requester) {
                    if (!requesterMarker) {
                        requesterMarker = L.marker([data.requester.lat, data.requester.lng], {icon: L.icon({iconUrl: "https://cdn-icons-png.flaticon.com/512/1077/1077012.png", iconSize: [32, 32]})})
                            .addTo(map)
                            .bindPopup("Requester: {{ br.requester.username }}")
                            .openPopup();
                        map.setView([data.requester.lat, data.requester.lng], 14);
                    } else {
                        requesterMarker.setLatLng([data.requester.lat, data.requester.lng]);
                    }
                }

                // Update donor markers
                data.donors.forEach(donor => {
                    if (!donorMarkers[donor.id]) {
                        donorMarkers[donor.id] = L.marker([donor.lat, donor.lng], {icon: L.icon({iconUrl: "https://cdn-icons-png.flaticon.com/512/1946/1946429.png", iconSize: [32, 32]})})
                            .addTo(map)
                            .bindPopup("Donor: " + donor.username);
                    } else {
                        donorMarkers[donor.id].setLatLng([donor.lat, donor.lng]);
                    }
                });
            })
            .catch(err => console.error("Location fetch error:", err));
    }

    // Auto-refresh every 5s
    setInterval(fetchLocations, 5000);
    fetchLocations();
</script>

<!-- Action Buttons -->
<div style="margin-top: 20px;">
    {% if request.user == br.requester %}
        <form action="{% url 'blood_requests:delete_request' br.id %}" method="POST" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn">üóë Delete Request</button>
        </form>
    {% else %}
        {% if request.user not in br.accepted_donors.all %}
            <a href="{% url 'blood_requests:accept_request' br.id %}" class="btn">‚úÖ Accept</a>
        {% else %}
            {% if not br.otp_verified %}
                <a href="{% url 'blood_requests:verify_otp' br.id %}" class="btn">üîë Verify OTP</a>
            {% endif %}

            {% with loc=request.user.live_location %}
                {% if loc and loc.is_sharing %}
                    <a href="{% url 'blood_requests:toggle_location_share' br.id %}" class="btn">‚èπ Stop Sharing</a>
                {% else %}
                    <a href="{% url 'blood_requests:toggle_location_share' br.id %}" class="btn">üì° Share Location</a>
                {% endif %}
            {% endwith %}
        {% endif %}
    {% endif %}
</div>

{% endblock %}

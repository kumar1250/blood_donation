{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block content %}
<div class="container mt-5">

    <!-- Welcome -->
    <h1 class="mb-4 text-danger">Welcome, {{ request.user.username }}!</h1>

    <!-- Quick Actions -->
    <h3 class="mt-4 mb-3 text-danger">Quick Actions</h3>
    <div class="row g-4">

        <!-- Action Cards -->
        {% comment %} Cards for actions like creating requests/camps, chat, etc. {% endcomment %}
        <div class="col-md-4 col-sm-6">
            <a href="{% url 'blood_requests:request_form' %}" class="card text-white bg-danger h-100 shadow-sm text-center text-decoration-none">
                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                    <i class="bi bi-plus-circle-fill fs-1"></i>
                    <h5 class="card-title mt-3">Create Blood Request</h5>
                </div>
            </a>
        </div>

        <div class="col-md-4 col-sm-6">
            <a href="{% url 'blood_requests:request_list' %}" class="card text-white bg-danger h-100 shadow-sm text-center text-decoration-none">
                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                    <i class="bi bi-list-ul fs-1"></i>
                    <h5 class="card-title mt-3">View All Requests</h5>
                </div>
            </a>
        </div>

        <div class="col-md-4 col-sm-6">
            <a href="{% url 'blood_camp:create_camp' %}" class="card text-white bg-danger h-100 shadow-sm text-center text-decoration-none">
                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                    <i class="bi bi-plus-square-fill fs-1"></i>
                    <h5 class="card-title mt-3">Create Blood Camp</h5>
                </div>
            </a>
        </div>

        <div class="col-md-4 col-sm-6">
            <a href="{% url 'blood_camp:camp_list' %}" class="card text-white bg-danger h-100 shadow-sm text-center text-decoration-none">
                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                    <i class="bi bi-geo-alt-fill fs-1"></i>
                    <h5 class="card-title mt-3">View All Camps</h5>
                </div>
            </a>
        </div>

        <div class="col-md-4 col-sm-6">
            <a href="{% url 'chat:chat_home' %}" class="card text-white bg-danger h-100 shadow-sm text-center text-decoration-none">
                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                    <i class="bi bi-chat-dots-fill fs-1"></i>
                    <h5 class="card-title mt-3">Chat</h5>
                </div>
            </a>
        </div>

        <div class="col-md-4 col-sm-6">
            <a href="{% url 'live_tracking:donor_map' %}" class="card text-white bg-danger h-100 shadow-sm text-center text-decoration-none">
                <div class="card-body d-flex flex-column justify-content-center align-items-center py-4">
                    <i class="bi bi-map-fill fs-1"></i>
                    <h5 class="card-title mt-3">View Donors Live Map</h5>
                </div>
            </a>
        </div>

    </div>

    <!-- Live Donor Map -->
    <h3 class="mt-5 mb-3 text-danger">Nearby Donors (Live)</h3>
    <div id="homeMap" style="height: 450px; border-radius: 10px;"></div>

</div>

<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
.card:hover { transform: scale(1.05); transition: transform 0.3s ease; }
@media (max-width: 576px) { 
    .card i { font-size: 2rem; } 
    .card-title { font-size: 1rem; } 
}
</style>

<script>
// Leaflet Icons
const donorIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [30,30] });
const meIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png', iconSize: [30,30] });

// Initialize map
const map = L.map('homeMap').setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let markers = {};
let myMarker = null;

// Track user location
if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if (myMarker) map.removeLayer(myMarker);
        myMarker = L.marker([lat, lng], {icon: meIcon}).addTo(map).bindPopup("You are here");

        fetch("{% url 'live_tracking:update_location' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
            body: JSON.stringify({ latitude: lat, longitude: lng, is_sharing: true })
        });

    }, err => console.error(err), { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
}

// Fetch donors every 5 seconds
function updateDonors() {
    fetch("{% url 'live_tracking:donor_data_json' %}?t=" + new Date().getTime())
        .then(res => res.json())
        .then(data => {
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};
            data.donors.forEach(d => {
                if (d.latitude && d.longitude) {
                    markers[d.user.id] = L.marker([d.latitude, d.longitude], {icon: donorIcon})
                        .addTo(map)
                        .bindPopup(d.user.username);
                }
            });
        })
        .catch(err => console.error(err));
}

updateDonors();
setInterval(updateDonors, 5000);
</script>
{% endblock %}

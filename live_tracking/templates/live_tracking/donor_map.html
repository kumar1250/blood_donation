{% extends "base.html" %}
{% block title %}All Live Donors{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-danger mb-3">Live Donors Map</h2>
    <div id="map" style="height: 500px;"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Icons
const donorIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // green pin
    iconSize: [30, 30],
});
const meIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png', // blue pin
    iconSize: [30, 30],
});
const requesterIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/3524/3524638.png', // red pin
    iconSize: [30, 30],
});

const map = L.map('map').setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let markers = {};
let myMarker = null;

// Track your live location using GPS
function trackMyLocation() {
    if (!navigator.geolocation) return;

    navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if (myMarker) map.removeLayer(myMarker);
        myMarker = L.marker([lat, lng], {icon: meIcon}).addTo(map).bindPopup("You are here");

        // Send location to server
        fetch("{% url 'live_tracking:update_location' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({latitude: lat, longitude: lng, is_sharing: true})
        });

    }, err => console.error("Error getting location:", err), {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    });
}

// Fetch donor locations every 5 seconds
function updateDonors() {
    fetch("{% url 'live_tracking:donor_data_json' %}?t=" + new Date().getTime())
        .then(r => r.json())
        .then(data => {
            // Remove old markers
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};

            // Donor markers
            data.donors.forEach(d => {
                if (d.latitude && d.longitude) {
                    markers[d.user.id] = L.marker([d.latitude, d.longitude], {icon: donorIcon})
                        .addTo(map)
                        .bindPopup(d.user.username);
                }
            });
        })
        .catch(err => console.error(err));
}

// Start tracking
trackMyLocation();
updateDonors();
setInterval(updateDonors, 5000);
</script>
{% endblock %}
